{% extends "base.html" %}

{% block title %}K·∫øt qu·∫£ d·ª± ƒëo√°n - {{ title }}{% endblock %}

{% block content %}
<section class="result-section">
    <div class="container">
        <!-- Header v·ªõi ti√™u ƒë·ªÅ phim -->
        <div class="result-header">
            <div class="result-breadcrumb">
                <a href="{{ url_for('home') }}">Trang ch·ªß</a>
                <span class="separator">‚Ä∫</span>
                <span>K·∫øt qu·∫£ d·ª± ƒëo√°n</span>
            </div>
            <h1 class="result-title">{{ title }}</h1>
            <p class="result-subtitle">Ph√¢n t√≠ch d·ª± ƒëo√°n th√†nh c√¥ng b·∫±ng AI</p>
        </div>

        <!-- Prediction Result Card -->
        <div class="result-main-card">
            <div class="prediction-result">
                <div class="prediction-circle-wrapper">
                    <div class="prediction-circle prediction-{{ color }}">
                        <div class="circle-inner">
                            <span class="circle-icon">{{ icon }}</span>
                            <span class="circle-percentage">{{ confidence }}%</span>
                        </div>
                        <svg class="circle-progress" viewBox="0 0 120 120">
                            <circle class="circle-bg" cx="60" cy="60" r="54"></circle>
                            <circle class="circle-fill" cx="60" cy="60" r="54" 
                                    style="--progress: {{ confidence }}"></circle>
                        </svg>
                    </div>
                </div>
                
                <div class="prediction-info">
                    <h2 class="prediction-status prediction-status-{{ color }}">
                        {{ prediction }}
                    </h2>
                    <p class="prediction-description">
                        {% if color == 'success' %}
                        M√¥ h√¨nh AI d·ª± ƒëo√°n phim n√†y c√≥ kh·∫£ nƒÉng <strong>ƒë·∫°t th√†nh c√¥ng cao</strong> 
                        d·ª±a tr√™n c√°c y·∫øu t·ªë: ng√¢n s√°ch, ƒë√°nh gi√°, th·ªÉ lo·∫°i v√† th·ªùi ƒëi·ªÉm ph√°t h√†nh.
                        {% else %}
                        M√¥ h√¨nh AI d·ª± ƒëo√°n phim n√†y c√≥ th·ªÉ <strong>g·∫∑p kh√≥ khƒÉn</strong> trong vi·ªác 
                        ƒë·∫°t ƒë∆∞·ª£c th√†nh c√¥ng th∆∞∆°ng m·∫°i theo ti√™u ch√≠ ƒë·ªÅ ra.
                        {% endif %}
                    </p>
                    
                    <div class="prediction-meta">
                        <div class="meta-item">
                            <span class="meta-icon">ü§ñ</span>
                            <div class="meta-content">
                                <span class="meta-label">M√¥ h√¨nh</span>
                                <span class="meta-value">{{ model_name }}</span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üéØ</span>
                            <div class="meta-content">
                                <span class="meta-label">Ng∆∞·ª°ng quy·∫øt ƒë·ªãnh</span>
                                <span class="meta-value">{{ threshold }}%</span>
                            </div>
                        </div>
                        <div class="meta-item">
                            <span class="meta-icon">üìä</span>
                            <div class="meta-content">
                                <span class="meta-label">X√°c su·∫•t th√†nh c√¥ng</span>
                                <span class="meta-value">{{ probability }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movie Details Grid -->
        <div class="result-grid">
            <div class="result-card details-card">
                <h3 class="card-title">
                    <span class="title-icon">üìã</span>
                    Th√¥ng tin phim
                </h3>
                <div class="details-list">
                    <div class="detail-row">
                        <span class="detail-label">üí∞ Ng√¢n s√°ch s·∫£n xu·∫•t</span>
                        <span class="detail-value">${{ "{:,.0f}".format(budget) }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üé¨ Th·ªÉ lo·∫°i</span>
                        <span class="detail-value detail-badge">{{ genre }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">‚≠ê ƒê√°nh gi√° trung b√¨nh</span>
                        <span class="detail-value">{{ vote_average }}/10</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üë• S·ªë l∆∞·ª£ng ƒë√°nh gi√°</span>
                        <span class="detail-value">{{ "{:,.0f}".format(vote_count) }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">‚è±Ô∏è Th·ªùi l∆∞·ª£ng</span>
                        <span class="detail-value">{{ runtime }} ph√∫t</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üìÖ NƒÉm ph√°t h√†nh</span>
                        <span class="detail-value">{{ release_year }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üìÜ Th√°ng ph√°t h√†nh</span>
                        <span class="detail-value">Th√°ng {{ release_month }}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">üåç Qu·ªëc gia s·∫£n xu·∫•t</span>
                        <span class="detail-value detail-badge">{{ country }}</span>
                    </div>
                </div>
            </div>

            <div class="result-card explanation-card">
                <h3 class="card-title">
                    <span class="title-icon">üß†</span>
                    Gi·∫£i th√≠ch d·ª± ƒëo√°n
                </h3>
                <div class="explanation-content">
                    <p class="explanation-intro">
                        D·ª± ƒëo√°n n√†y ƒë∆∞·ª£c t√≠nh to√°n b·ªüi m√¥ h√¨nh Machine Learning ti√™n ti·∫øn, 
                        ph√¢n t√≠ch to√†n di·ªán c√°c y·∫øu t·ªë ·∫£nh h∆∞·ªüng ƒë·∫øn th√†nh c√¥ng c·ªßa phim:
                    </p>
                    <ul class="explanation-list">
                        <li>
                            <span class="list-icon">üíµ</span>
                            <div class="list-content">
                                <strong>Ng√¢n s√°ch & Th·ªùi l∆∞·ª£ng</strong>
                                <p>Ph√¢n t√≠ch hi·ªáu qu·∫£ ƒë·∫ßu t∆∞ v√† ƒë·ªô d√†i h·ª£p l√Ω c·ªßa phim</p>
                            </div>
                        </li>
                        <li>
                            <span class="list-icon">‚≠ê</span>
                            <div class="list-content">
                                <strong>ƒê√°nh gi√° & L∆∞·ª£ng vote</strong>
                                <p>Ch·∫•t l∆∞·ª£ng n·ªôi dung v√† s·ª± ƒë√≥n nh·∫≠n c·ªßa kh√°n gi·∫£</p>
                            </div>
                        </li>
                        <li>
                            <span class="list-icon">üìÖ</span>
                            <div class="list-content">
                                <strong>Th·ªùi ƒëi·ªÉm ph√°t h√†nh</strong>
                                <p>Y·∫øu t·ªë th·ªùi v·ª•, m√πa cao ƒëi·ªÉm v√† th·ªùi ƒëi·ªÉm chi·∫øn l∆∞·ª£c</p>
                            </div>
                        </li>
                        <li>
                            <span class="list-icon">üé≠</span>
                            <div class="list-content">
                                <strong>Th·ªÉ lo·∫°i & Th·ªã tr∆∞·ªùng</strong>
                                <p>Xu h∆∞·ªõng th·ªÉ lo·∫°i v√† s·ªü th√≠ch theo khu v·ª±c ƒë·ªãa l√Ω</p>
                            </div>
                        </li>
                        <li>
                            <span class="list-icon">üî¨</span>
                            <div class="list-content">
                                <strong>Feature Engineering</strong>
                                <p>ROI, budget/ph√∫t, vote score v√† c√°c t∆∞∆°ng t√°c ph·ª©c t·∫°p</p>
                            </div>
                        </li>
                    </ul>
                    <div class="explanation-note">
                        <span class="note-icon">‚ÑπÔ∏è</span>
                        <p>
                            M√¥ h√¨nh ƒë∆∞·ª£c hu·∫•n luy·ªán v·ªõi hyperparameter tuning, SMOTE ƒë·ªÉ x·ª≠ l√Ω 
                            m·∫•t c√¢n b·∫±ng d·ªØ li·ªáu, v√† threshold optimization nh·∫±m t·ªëi ∆∞u F1-Score.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="result-actions">
            <button class="btn btn-ai" id="getAIAdviceBtn">
                <span class="btn-icon">‚ú®</span>
                Nh·∫≠n g√≥p √Ω t·ª´ chuy√™n gia
            </button>
            <a href="{{ url_for('home') }}" class="btn btn-primary">
                <span class="btn-icon">üé¨</span>
                D·ª± ƒëo√°n phim kh√°c
            </a>
            <a href="{{ url_for('data_analysis') }}" class="btn-outline">
                <span class="btn-icon">üìä</span>
                Xem ph√¢n t√≠ch d·ªØ li·ªáu
            </a>
        </div>
    </div>
</section>

<!-- AI Advice Modal -->
<div id="aiAdviceModal" class="modal">
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>
                <span class="modal-icon">ü§ñ</span>
                G√≥p √Ω t·ª´ chuy√™n gia Khu√™ ƒêinh
            </h3>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body">
            <div id="aiAdviceLoading" class="loading-state">
                <div class="loading-spinner"></div>
                <p>Ch·ªù ch√∫t ƒëi tui suy nghƒ© c√°i ƒë√£..</p>
            </div>
            <div id="aiAdviceContent" class="advice-content" style="display: none;">
                <!-- AI response will be inserted here -->
            </div>
            <div id="aiAdviceError" class="error-state" style="display: none;">
                <span class="error-icon">‚ö†Ô∏è</span>
                <p>Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi chuy√™n gia. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-outline" id="modalCloseBtn">ƒê√≥ng</button>
        </div>
    </div>
</div>

<script>
// Store movie data for AI request
const movieData = {
    title: {{ title|tojson }},
    prediction: {{ prediction|tojson }},
    confidence: {{ confidence|tojson }},
    probability: {{ probability|tojson }},
    budget: {{ budget|tojson }},
    genre: {{ genre|tojson }},
    vote_average: {{ vote_average|tojson }},
    vote_count: {{ vote_count|tojson }},
    runtime: {{ runtime|tojson }},
    release_year: {{ release_year|tojson }},
    release_month: {{ release_month|tojson }},
    country: {{ country|tojson }}
};

// Modal controls
const modal = document.getElementById('aiAdviceModal');
const modalOverlay = document.getElementById('modalOverlay');
const modalClose = document.getElementById('modalClose');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const getAdviceBtn = document.getElementById('getAIAdviceBtn');
const loadingState = document.getElementById('aiAdviceLoading');
const contentState = document.getElementById('aiAdviceContent');
const errorState = document.getElementById('aiAdviceError');

// Open modal and fetch AI advice
getAdviceBtn.addEventListener('click', async () => {
    modal.classList.add('modal-open');
    document.body.style.overflow = 'hidden';
    
    // Reset states
    loadingState.style.display = 'flex';
    contentState.style.display = 'none';
    errorState.style.display = 'none';
    
    try {
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); // 10 second timeout
        
        const response = await fetch('/api/ai-advice', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(movieData),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
            throw new Error('API request failed');
        }
        
        const data = await response.json();
        
        // Hide loading, show content
        loadingState.style.display = 'none';
        contentState.style.display = 'block';
        contentState.innerHTML = formatAIResponse(data.advice);
        
        // Show badge if using fallback
        if (data.fallback) {
            const badge = document.createElement('div');
            badge.style.cssText = 'background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.3); color: var(--accent-secondary); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; margin-bottom: 12px; text-align: center;';
            badge.innerHTML = '‚ö° Advice nhanh (offline mode)';
            contentState.insertBefore(badge, contentState.firstChild);
        }
        
    } catch (error) {
        console.error('Error fetching AI advice:', error);
        
        // Check if it's a timeout error
        if (error.name === 'AbortError') {
            console.log('Request timed out, using fallback advice');
            // Show fallback content immediately
            loadingState.style.display = 'none';
            contentState.style.display = 'block';
            
            // Use one of the fallback advices
            const fallbackAdvice = `### Ph√¢n t√≠ch t·ª´ chuy√™n gia

**ƒê√°nh gi√° t·ªïng quan:**

D·ª±a tr√™n c√°c ch·ªâ s·ªë b·∫°n cung c·∫•p, d·ª± √°n phim c·ªßa b·∫°n c√≥ nh·ªØng ƒëi·ªÉm m·∫°nh ƒë√°ng ch√∫ √Ω nh∆∞ng c≈©ng c·∫ßn c·∫£i thi·ªán m·ªôt s·ªë kh√≠a c·∫°nh ƒë·ªÉ t·ªëi ∆∞u h√≥a c∆° h·ªôi th√†nh c√¥ng. H√£y c√πng xem x√©t chi ti·∫øt:

**ƒêi·ªÉm m·∫°nh:**

- **Ng√¢n s√°ch h·ª£p l√Ω:** M·ª©c ƒë·∫ßu t∆∞ cho th·∫•y s·ª± c√¢n nh·∫Øc k·ªπ l∆∞·ª°ng, gi√∫p ki·ªÉm so√°t r·ªßi ro t√†i ch√≠nh
- **Th·ªÉ lo·∫°i ph√π h·ª£p:** L·ª±a ch·ªçn th·ªÉ lo·∫°i ph√π h·ª£p v·ªõi xu h∆∞·ªõng th·ªã tr∆∞·ªùng hi·ªán t·∫°i
- **Th·ªùi ƒëi·ªÉm ph√°t h√†nh:** K·∫ø ho·∫°ch ra m·∫Øt ƒë∆∞·ª£c c√¢n nh·∫Øc ƒë·ªÉ t·ªëi ∆∞u doanh thu

**C√°c kh√≠a c·∫°nh c·∫ßn c·∫£i thi·ªán:**

- **Marketing & Promotion:** TƒÉng c∆∞·ªùng chi·∫øn d·ªãch truy·ªÅn th√¥ng ƒë·ªÉ n√¢ng cao nh·∫≠n di·ªán
- **Ch·∫•t l∆∞·ª£ng n·ªôi dung:** ƒê·∫ßu t∆∞ v√†o k·ªãch b·∫£n v√† di·ªÖn xu·∫•t ƒë·ªÉ ƒë·∫£m b·∫£o ƒë√°nh gi√° t√≠ch c·ª±c
- **Ph√¢n ph·ªëi:** M·ªü r·ªông k√™nh ph√¢n ph·ªëi ƒë·ªÉ ti·∫øp c·∫≠n ƒëa d·∫°ng kh√°n gi·∫£

**Khuy·∫øn ngh·ªã h√†nh ƒë·ªông:**

1. T·∫≠p trung v√†o ch·∫•t l∆∞·ª£ng n·ªôi dung v√† k·ªãch b·∫£n
2. X√¢y d·ª±ng chi·∫øn l∆∞·ª£c marketing ƒëa k√™nh hi·ªáu qu·∫£  
3. Nghi√™n c·ª©u k·ªπ ƒë·ªëi th·ªß c·∫°nh tranh trong c√πng th·ªÉ lo·∫°i
4. T·ªëi ∆∞u h√≥a th·ªùi ƒëi·ªÉm v√† chi·∫øn l∆∞·ª£c ph√°t h√†nh

**K·∫øt lu·∫≠n:**

V·ªõi nh·ªØng ƒëi·ªÅu ch·ªânh ph√π h·ª£p, d·ª± √°n c·ªßa b·∫°n c√≥ ti·ªÅm nƒÉng ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ t√≠ch c·ª±c. H√£y t·∫≠p trung v√†o vi·ªác n√¢ng cao ch·∫•t l∆∞·ª£ng n·ªôi dung v√† tri·ªÉn khai chi·∫øn l∆∞·ª£c marketing hi·ªáu qu·∫£.`;
            
            contentState.innerHTML = formatAIResponse(fallbackAdvice);
            
            const badge = document.createElement('div');
            badge.style.cssText = 'background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); color: var(--warning); padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; margin-bottom: 12px; text-align: center;';
            badge.innerHTML = '‚è±Ô∏è Timeout - Hi·ªÉn th·ªã advice nhanh';
            contentState.insertBefore(badge, contentState.firstChild);
        } else {
            // Other errors - show error state
            loadingState.style.display = 'none';
            errorState.style.display = 'flex';
        }
    }
});

// Close modal handlers
function closeModal() {
    modal.classList.remove('modal-open');
    document.body.style.overflow = '';
}

modalClose.addEventListener('click', closeModal);
modalCloseBtn.addEventListener('click', closeModal);
modalOverlay.addEventListener('click', closeModal);

// Format AI response with markdown-like styling
function formatAIResponse(text) {
    // Convert markdown-style formatting to HTML
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // Split into paragraphs
    const paragraphs = text.split('\n\n');
    let html = '';
    
    paragraphs.forEach(para => {
        if (para.trim().startsWith('###')) {
            // Heading
            html += `<h4>${para.replace(/###\s*/, '')}</h4>`;
        } else if (para.trim().startsWith('-') || para.trim().startsWith('‚Ä¢')) {
            // List
            const items = para.split('\n').filter(line => line.trim());
            html += '<ul>';
            items.forEach(item => {
                html += `<li>${item.replace(/^[-‚Ä¢]\s*/, '')}</li>`;
            });
            html += '</ul>';
        } else if (para.trim()) {
            // Regular paragraph
            html += `<p>${para}</p>`;
        }
    });
    
    return html;
}

// Escape key to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('modal-open')) {
        closeModal();
    }
});
</script>
{% endblock %}